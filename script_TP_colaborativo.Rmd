---
title: "R Notebook"
output: html_notebook
---

# LIBRERIAS
```{r, warning=FALSE}
library(corrplot)
library(ggplot2)
library(tidyverse)
library(readxl)
library(mongolite)
library(sqldf)
library(isotree)
library(Rlof)
library(lubridate)
library(mice)
library(randomForest)
```
# CARGA DE BASES 

## Bases Igal
```{r}
#dir igal
df_artist <- read.csv("C:/Users/igalk/OneDrive/Documentos/laburo/Data Mining FCEyN/Data mining/TP/data_mining/data/df_artist_sin_duplicados.csv")
# 
#borrado de duplicados que quedaron
# 
# # # 
 df_charts <- read.csv("C:/Users/igalk/OneDrive/Documentos/laburo/Data Mining FCEyN/Data mining/TP/data_mining/data/df_charts_sin_duplicados.csv")
# # # 
 df_audio_features <- read.csv("C:/Users/igalk/OneDrive/Documentos/laburo/Data Mining FCEyN/Data mining/TP/audio_features_plano_sin_duplicados.csv")
```

## Bases Mateo
```{r}
df_artist <- read.csv("data/df_artist_sin_duplicados.csv")
df_charts <- read.csv("data/df_charts_sin_duplicados.csv")
df_audio_features <- read.csv("data/audio_features_plano_sin_duplicados.csv")
```

## Bases Nacho
```{r}
#dir Nacho
df_artist <- read.csv("C:/Users/Asus/Desktop/DATA SCIENCE/MAESTRIA/Data Mining/TP/data/df_artist_sin_duplicados.csv")
df_charts <- read.csv("C:/Users/Asus/Desktop/DATA SCIENCE/MAESTRIA/Data Mining/TP/data/df_charts_sin_duplicados.csv")
df_audio_features <- read.csv("C:/Users/Asus/Desktop/DATA SCIENCE/MAESTRIA/Data Mining/TP/data/audio_features_plano_sin_duplicados.csv")
```

## Nueva Corrección duplicados
```{r}
#borro duplicados que quedaron en el audio_features
#queda listo para el join con chrats
df_audio_features <- df_audio_features %>% 
  group_by(track_name, external_urls_spotify) %>% 
  mutate(artist_all = paste(artist_name, collapse = ",|,")) %>%
  ungroup() %>% 
  mutate(artist_key = sub(",|,.*", "", artist_all)) %>% 
  select(artist_name, artist_all, artist_key, everything(.)) %>% 
  distinct(artist_key, external_urls_spotify, .keep_all = T) %>% 
  as.data.frame()
```


# ANALISIS DE NULOS
```{r}

md.pattern(df_audio_features, rotate.names = TRUE) #faltan dos columas irrelevantes
md.pattern(df_charts, rotate.names = TRUE)
#md.pattern(df_artist, rotate.names = TRUE) #no tiene sentido con 1 sola columna

```


# ANALISIS DE SEMANAS Y MERCADOS
```{r}
#chequeo de semanas: tenemos 157 semanas en total, 200 temas por semana
df_charts %>% mutate(week_number = week(week_start), 
                     anio = year(week_start),
                     week_anio = paste(anio,week_number, sep = "-")) %>% 
  select(week_start, week_number, anio, week_anio) %>% 
  group_by(week_anio) %>% 
  summarise(n = n())
  

#armo columna con cantidad de paises donde está disponible cada canción

contar_market <- function(x){
q <- length(unlist(strsplit(x, split = ",")))
return (q)
  }
df_audio_features$cant_markets <- sapply(df_audio_features[,"markets_concat"], contar_market)

summary(df_audio_features$cant_markets) #hay canciones en cero países. Están dadas de baja
# df_audio_features[order(-df_audio_features$cant_markets),"cant_markets"]


# head(df_audio_features[1:300,], 300)
```

# VECTORES DE FEATURES
```{r}
#features var continuos
features_continuas <- c('acousticness', 'danceability', 'duration_ms', 'energy', 'instrumentalness', 'liveness', 'loudness', 'speechiness',   'tempo', 'valence', 'cant_markets')

#features var_ categóricas
features_categoricas <- c('explicit', 'key_name', 'mode_name', "key_mode", "album_type")
#sacamos_market concat porque la pasamos a cantiddad de mercados
```

# JOIN `audio_features` Y `charts`
```{r}

#Armamos un join para tener una tabla de charts con las caracteristicas de las canciones
# deberian quedar 22993 filas completas
join_audio_charts <- df_audio_features %>% 
  select("artist_name","artist_all","artist_key",
         "track_name", "external_urls_spotify",
         features_continuas, features_categoricas) %>% 
  right_join( df_charts %>%
               select( "Track_Name", "Artist", 
                       "URL","Position", "Streams", "week_start", "week_end"),
               by = c(
                 "track_name" = "Track_Name", 
                      "artist_key" ="Artist", 
                      "external_urls_spotify" = "URL"))


x <- nrow(df_charts)- nrow(join_audio_charts)

#Análisis de NA
md.pattern(join_audio_charts, rotate.names = TRUE) #HAY CHARTS QUE NO TIENEN FEATURES. HAY QUE TENERLO EN CUENTA PARA EL ANÁLISIS
```

# HISTOGRAMAS Y BARPLOTS DE VARIABLES
```{r}

##histograma de las variables continuas de audio_features

for (i in features_continuas){

  hist(df_audio_features[,i], main = paste("Histograma de", i, "(all data)"), xlab = i)
  abline(v = mean(df_audio_features[,i], na.rm = TRUE) , col="red")
  abline(v = median(df_audio_features[,i], na.rm = TRUE) , col="blue")
  legend("topright", legend = c("Media", "Mediana"), col=c("red", "blue"), lty =1)

}

#divido los features por su distribución
features_continuas_media <- c('danceability', 'tempo', 'valence')

features_continuas_mediana <- c('acousticness', 'duration_ms', 'energy', 'instrumentalness', 'liveness', 'loudness', 'speechiness', 'cant_markets')


##histograma de las variables continuas de charts
for (i in c(features_continuas, "Streams")){

  hist(join_audio_charts[,i], main = paste("Histograma de", i,  "(charts)"), xlab = i)
  abline(v = mean(join_audio_charts[,i], na.rm = TRUE) , col="red")
  abline(v = median(join_audio_charts[,i], na.rm = TRUE) , col="blue")

}

#divido features de charts según su distribución
audio_charts_continuas_media <- c('duration_ms', 'valence')

audio_charts_continuas_mediana <- c('danceability', 'acousticness', 'tempo', 'energy', 'instrumentalness', 'liveness', 'loudness', 'speechiness', 'cant_markets', "Streams")


##medidas resumen y barplots de las variables categoricas audio_features
for(i in features_categoricas){

  barplot(sort(table(df_audio_features[,i]),decreasing = T), las=2, 
          main = paste("Barplot de", i, "(all data)"))
  # pie(table(df_features_categoricos[,i]))
}



##medidas resumen y barplots de las variables categoricas join_audio_charts

for(i in features_categoricas){
  
  barplot(sort(table(join_audio_charts[,i]),decreasing = T), las=2, 
          main = paste("Barplot de", i, "(charts)"))
  # pie(table(df_features_categoricos[,i]))
}


###### 
##Lo rehice abajo, perdón con la insistencia, je. 
######

#cantidad de veces que aparece cada país (lo sacamos porque na da nada interpretable)
#vector <- unlist(strsplit(df_audio_features[1,"markets_concat"], split = ","))
#x <- table (vector)
#x <- sort(x)
#barplot(x, las=2)

```

## Analisis de la variable `markets_concat`

```{r}
#Hago un join al revés 

df_chart_tojoin <- df_charts[,c("Track_Name", "Artist", "URL")]
df_chart_tojoin$isinchart <- 1
df_audio_features_tojoin <- df_audio_features[, c("track_name","artist_key","external_urls_spotify","markets_concat")]

join_barplot <- df_audio_features_tojoin %>% 
  select("track_name","artist_key","external_urls_spotify","markets_concat") %>% 
  left_join( df_chart_tojoin %>%
               select("Track_Name", "Artist", "URL","isinchart"),
               by = c(
                 "track_name" = "Track_Name", 
                      "artist_key" ="Artist", 
                      "external_urls_spotify" = "URL"))


join_barplot$isinchart[is.na(join_barplot$isinchart)] <- 0

join_barplot$isinchart <- factor(join_barplot$isinchart)

tabla_isinchart <- table(unlist(lapply(join_barplot[join_barplot$isinchart==1,"markets_concat"], function(x) strsplit(as.character(x), ','))))

tabla_notinchart <- table(unlist(lapply(join_barplot[join_barplot$isinchart==0,"markets_concat"], function(x) strsplit(as.character(x), ','))))

par(mfrow = c(1,2))
barplot(sort(tabla_isinchart, decreasing = TRUE), names.arg="", xlab='En Charts')
barplot(sort(tabla_notinchart, decreasing = TRUE), names.arg = "", xlab='Fuera de Charts')
```


# CORRELACIONES
```{r}
#análisis de correlación numericas

#correlaciones en audio features
x <- cor(df_audio_features[,c(features_continuas_media, features_continuas_mediana)],  use =  "complete.obs")
corrplot(x, type = "upper", title = "Correlacion de atributos de audio", mar=c(0,0,1,0), method="number" ,number.cex=0.7)

#correlaciones en charts
x <- cor(join_audio_charts[,c(audio_charts_continuas_media, audio_charts_continuas_mediana)], use =  "complete.obs")
corrplot(x, type = "upper", title = "Correlacion de atributos de los Charts", mar=c(0,0,1,0), method="number", number.cex=0.7 )

#chi2 test #con n grande no se puede usar este test
tabla_key_album <- table(df_audio_features$key_name, df_audio_features$album_type)
cat("Tabla de contigencia entre key y album type\n")
tabla_key_album
chisq.test(tabla_key_album)

```


# ANALISIS DE OUTLIERS UNIVARIADO


## Revisión de Coeficiente de Variación Variables Numéricas
```{r}
## Metricas de variacion
coef_var <- function(col){
  media = abs(mean(col, na.rm = T))
  stdv = sd(col, na.rm = T)
  return(round(stdv/media,3))
}

#coeficiente de variacion audio_features
cat("coeficiente de variacion\n")
cv <- apply(df_audio_features[,c(features_continuas_media, features_continuas_mediana)], 2, coef_var)
cv_features <- sort(cv, decreasing = T)

cat("\ndesvio_standard\n")
desvio_standard <- round(apply(df_audio_features[,c(features_continuas_media, features_continuas_mediana)], 2, sd),2)
desvio_standard[order(names(desvio_standard))]


#coeficiente de variacion charts
cat("coeficiente de variacion\n")
cv <- apply(join_audio_charts[,c(audio_charts_continuas_media, audio_charts_continuas_mediana)], 2, coef_var)
cv_charts <- sort(cv, decreasing = T)

cat("\ndesvio_standard\n")
desvio_standard <- round(apply(join_audio_charts[,c(audio_charts_continuas_media, audio_charts_continuas_mediana)], 2, sd, na.rm=TRUE),2)
desvio_standard[order(names(desvio_standard))]

# cuadro comparativo sobre las variaciones de las caractersiticas de las canciones
#entre todas y charts
as.data.frame(cbind(cv_features, cv_charts))

```

## Boxplots Variables Numéricas sin filtra outliers
```{r}
boxplot(scale(df_audio_features[,c(features_continuas_media, features_continuas_mediana)]), las=2)
```

## Boxplots Variables Numéricas filtrando outliers por método del rango intercuartil

```{r}

sin_outliers_box <- function(col){
  name <- col
  col <- df_audio_features[,col]
  iqr_col <- IQR(col)
  cuartil1 <- quantile(col, na.rm = T, probs = c(0.25))
  cuartil3 <- quantile(col, na.rm = T, probs = c(0.75))
  conditions <- (col>cuartil1-1.5*iqr_col) & (col<cuartil3+1.5*iqr_col) 
  bp <- boxplot(scale(col[conditions]), main=name, horizontal = T)
  return(bp)
}

all_features <- c(features_continuas_media, features_continuas_mediana)

par(mfrow=c(4,3))
for (feature in all_features){
  sin_outliers_box(feature)
}

```


### Z-Score de Variables que "tienden a la normal"
```{r}

################################

## FILTRAMOS OUTLIERS POR Z-SCORE para 'danceability', 'tempo', 'valence'

##############################

#z-score para variables que tienden a la normal
#filtro features numericos 

#divido los features por su distribución
features_continuas_media <- c('danceability', 'tempo', 'valence')
df_audio_features_zscore_media <- df_audio_features[,features_continuas_media]

#normalizo z score con las variables que tienden a la normal

zscore_cols <- c()
for(col in names(df_audio_features_zscore_media)){
  name_col <- paste('zscore_',col, sep = "")
  zscore_cols <- append(zscore_cols, name_col)
  media <-  mean(df_audio_features_zscore_media[,col])
  stdv <- sd(df_audio_features_zscore_media[,col])
  df_audio_features_zscore_media[,name_col] <- (df_audio_features_zscore_media[,col] - media)/stdv
  }

par(mfrow=c(1,length(zscore_cols)))
lapply(zscore_cols, function(col) boxplot(df_audio_features_zscore_media[,col],xlab=col))
```

### Analisis de Z-Score por variable
 
#### Danceability

```{r}
#variable: danceability

umbral_zscore <- 3
conditions <- (df_audio_features_zscore_media$zscore_danceability> umbral_zscore) | (df_audio_features_zscore_media$zscore_danceability< -1*umbral_zscore)
df_audio_features[conditions,] %>%
  select(album_name,artist_name, danceability ) %>%
  arrange(-danceability)
```
#### Tempo

```{r}
#variable: Tempo

umbral_zscore <- 3
conditions <- (df_audio_features_zscore_media$zscore_tempo> umbral_zscore) | (df_audio_features_zscore_media$zscore_tempo< -1*umbral_zscore)
df_audio_features[conditions,] %>%
  select(album_name,artist_name, tempo ) %>%
  arrange(-tempo)
```

#### Valence

```{r}
#variable: valence
umbral_zscore <- 3
conditions <- (df_audio_features_zscore_media$zscore_valence> umbral_zscore) | (df_audio_features_zscore_media$zscore_valence< -1*umbral_zscore)
df_audio_features[conditions,] %>%
  select(album_name,artist_name, valence ) %>%
  arrange(-valence)
```

### Z-Score Modificado de Variables Asimetricas

```{r}
################################

## FILTRAMOS OUTLIERS POR Z-SCORE MODIFICADO para 'acousticness', 'duration_ms', 'energy',  'instrumentalness', 'liveness', 'loudness', 'speechiness', 'cant_markets'

##############################

features_continuas_mediana <- c('acousticness', 'duration_ms', 'energy', 'instrumentalness', 'liveness', 'loudness', 'speechiness', 'cant_markets')

df_audio_features_zscore_mediana <- df_audio_features[,features_continuas_mediana]



zscoremodif_cols <- c()
for(col in names(df_audio_features_zscore_mediana)){
  name_col <- paste('zscoremodif_',col, sep = "")
  zscoremodif_cols <- append(zscoremodif_cols, name_col)
  med = median(df_audio_features_zscore_mediana[,col], na.rm = T)
  MAD = median(abs(df_audio_features_zscore_mediana[,col] - med), na.rm = T)
  df_audio_features_zscore_mediana[, name_col] <- 0.6745 * (df_audio_features_zscore_mediana[,col] - med) / MAD
}


par(mfrow=c(4,2))
lapply(zscoremodif_cols, function(col) boxplot(df_audio_features_zscore_mediana[,col],xlab=col, horizontal = T))

```


#### Revisión Variable `Instrumentalness`
```{r}
instrumentalness <- c("instrumentalness", "zscoremodif_instrumentalness") 

x <- df_audio_features$instrumentalness

n_interv <- 8


intervalos <- round(seq(0,max(x),by=(max(x)-min(x))/n_interv),2)

labs <- c()
for (i in 1:n_interv){
lab <- paste(intervalos[i],intervalos[i+1], sep='\n')
labs <- append(labs, lab)
    
}

bins <- cut(x, n_interv, include.lowest = TRUE, labels = labs)

barplot(table(bins))

```





```{r}

#################################

#analisis de outliers ¿quíenes son los que me voy a sacar de encima?

#cuantos artistas
length(unique(df_audio_features["artist_name"][df_audio_features$duration_ms < duration.bigote.inferior,]))

#observo nuevo boxplot con outliers filtados de duration_ms
boxplot(df_audio_features["duration_ms"][df_audio_features["duration_ms"] <= duration.bigote.superior ])

#calculo umbral para loudness
loudness.bigote.inferior <- boxplot(df_audio_features$loudness)$stats[1]

#guardo nuevo dataset filtrado (nro instancias 140k, perdemos 16k registros )
df_audio_features_filtrado <- df_audio_features %>% 
  filter(duration_ms <= duration.bigote.superior &
         loudness >= loudness.bigote.inferior)

####################################

#
# nuevo boxplot con las variables filtradas

####################################

#

```



# Eliminacion atributos redundantes

```{r}
###########################################

# borro atributos redundantes. Paso 1
#               correlograma

#########################################

#audio charts
df_audio_charts_cuanti <- join_audio_charts[,c("track_name",audio_charts_continuas_media, audio_charts_continuas_mediana)]

df_audio_charts_cuanti <- df_audio_charts_cuanti[complete.cases(df_audio_charts_cuanti) == TRUE,]

df_audio_charts_cuanti <- df_audio_charts_cuanti %>% group_by(track_name) %>%
                                                 mutate(Streams= max(Streams)) %>%
                                                 distinct(track_name, .keep_all = TRUE)

corr_charts <- cor(df_audio_charts_cuanti[,2:ncol(df_audio_charts_cuanti)])

df_audio_charts_s_at_redund <- caret::findCorrelation(corr_charts, cutoff=0.60, names=TRUE, verbose= TRUE)

print(df_audio_charts_s_at_redund) # Energy  tienen alta correlación con otras variables.
                                  
df_audio_charts_s_at_redund <- df_audio_charts_cuanti %>% select(-c("energy")) # La borramos!

# conclusión: chau energy, sucede porque es combinación de otras.

##########################################

#paso 2: busqueda de features con poca variabilidad

#######################################

lvf <-  df_audio_charts_s_at_redund[,2:ncol(df_audio_charts_s_at_redund)]

#normalizo todas las variables entre 0 y 1
for(i in 1:ncol(lvf)) {
  lvf[,i] <- (lvf[,i]-min(lvf[,i]))/(max(lvf[,i])-min(lvf[,i]))
}
varianzas<-sort(round(apply(lvf, 2, var),4))

df_audio_charts_s_at_redund <- cbind(track_name = df_audio_charts_s_at_redund$track_name, lvf)

# Borro atributos con poca variablilidad:

df_audio_charts_s_at_redund <- df_audio_charts_s_at_redund %>% select(-c("instrumentalness", "duration_ms", "Streams", "loudness", "speechiness", "liveness"))

cor(df_audio_charts_s_at_redund[,2:6]) # hay baja correlacion entre ellas. buena limpieza!

```




```{r}

###################################################

#                     CPA - AUDIO CHARTS

################################################

df_audio_charts_s_at_redund.PCA = prcomp(df_audio_charts_s_at_redund[,2:6], scale. = TRUE)

df_audio_charts_s_at_redund.PCA$rotation #autovectores de CPA

summary(df_audio_charts_s_at_redund.PCA) #Primeros tres autovectores me explican el 70%


carga1 = data.frame(carga_1 = df_audio_charts_s_at_redund.PCA$rotation[,1])
carga2 = data.frame(carga_2 = df_audio_charts_s_at_redund.PCA$rotation[,2])
carga3 = data.frame(carga_3 = df_audio_charts_s_at_redund.PCA$rotation[,3])

print(round(cbind(carga1,carga2, carga3),2))

CP1 = as.matrix(df_audio_charts_s_at_redund[,2:6])%*%as.matrix(carga1[,"carga_1"])
CP2 = as.matrix(df_audio_charts_s_at_redund[,2:6])%*%as.matrix(carga2[,"carga_2"])
df_audio_charts_s_at_redund$CP1 = CP1
df_audio_charts_s_at_redund$CP2 = CP2

plot(df_audio_charts_s_at_redund$CP1, df_audio_charts_s_at_redund$CP2)

# PENDIENTE: ARMAR BIPLOT
#ggbiplot(df_audio_charts_s_at_redund.PCA, obs.scale=0.75 ,var.scale=0.75,alpha=1,labels = datos_agrupados$carrera)


```



```{r}

######################################################################
#                                                                    #
#      Análisis de los datos (respuesta a  las preguntas del TP)     #
#                                                                    #
######################################################################

#outliers multivariados
#Isolation Forest

#método 2: isolation forest (categóticas y continuas)

#ajusto el modelo


iforest_sample = isolation.forest(as.matrix(df_audio_charts_s_at_redund[,7:8]), sample_size = 800, ntrees=100, ndim = 2, random_seed = 1)

#utilzo el metodo predict para calcula el score sobre todos los puntos
df_audio_charts_s_at_redund$iforest_pred = predict(iforest_sample, df_audio_charts_s_at_redund[,7:8])

#que paises identifico?
top_ifores_sample <- head(df_audio_charts_s_at_redund[order(df_audio_charts_s_at_redund$iforest_pred, decreasing = T),], 200)
print(top_ifores_sample)

freq_outlier <- as.data.frame(table(join_audio_charts[join_audio_charts$track_name%in% top_ifores_sample$track_name,"track_name"]))

summary(freq_outlier)

freq_outlier_menos_de_10 <- freq_outlier[freq_outlier$Freq>50,]

#GRAFICO!!!
plot(df_audio_charts_s_at_redund$CP1, df_audio_charts_s_at_redund$CP2,
     col=ifelse(df_audio_charts_s_at_redund$track_name %in% top_ifores_sample$track_name, "red", "blue"),
     pch=ifelse(df_audio_charts_s_at_redund$track_name %in% freq_outlier_menos_de_10$Var1,18,1),
     cex=ifelse(df_audio_charts_s_at_redund$track_name %in% freq_outlier_menos_de_10$Var1,3,1))

hist(freq_outlier$Freq)

```





# Preguntas de investigacion

## Patron Comun Canciones del Chart
¿Qué características tienen las canciones que están en el chart? ¿Cual es el patrón comun que tienen las canciones más escuchadas? (ver dispersiones, media, grafico comparativo)
```{r}


#funcion para escalar variable
scale_vble <- function(x){
  (x - mean(x, na.rm = T))/sd(x, na.rm = T)
}

#borro NA y escalo los audio features del chart
join_audio_charts_complete <- na.omit(join_audio_charts)
join_audio_charts_complete_scale <- join_audio_charts_complete %>% 
  distinct() %>% 
  select(features_continuas)  %>% 
  mutate_all(scale_vble)
nrow(join_audio_charts_complete_scale)

#borro NA y escalo los audio features 
df_audio_features_complete <- na.omit(df_audio_features)
df_audio_features_complete_scale <- df_audio_features_complete %>%  
  distinct() %>% 
  select(features_continuas) %>% 
  mutate_all(scale_vble)
nrow(df_audio_features_complete)

#chequeo eliminacion de NA's
sum(!complete.cases(join_audio_charts_complete_scale))  
sum(!complete.cases(df_audio_features_complete))  
```
```{r}
#anti_join
anti_join_audio_charts <- df_audio_features %>% 
  select("artist_name","artist_all", "artist_key",
         "track_name", "external_urls_spotify", 
         features_continuas, features_categoricas) %>% 
  anti_join( df_charts %>%
               select( "Track_Name", "Artist", "URL"),
               by = c("external_urls_spotify" ="URL",
                      "artist_key" ="Artist"  ))
               # by = c("track_name" = "Track_Name"))


anti_join_audio_charts_complete <- na.omit(anti_join_audio_charts)
anti_join_audio_charts_complete_scale <- anti_join_audio_charts_complete %>% 
  distinct() %>% 
  select(features_continuas)  %>% 
  mutate_all(scale_vble)
nrow(anti_join_audio_charts_complete_scale)
```
### Histogramas comparativos
(comentar o descomentar segun se trate de la comparacion de los features de los temas del chart vs todos o solo vs no charts)
```{r}
for (i in features_continuas) {
  print(join_audio_charts_complete_scale %>%
            mutate(is_chart = "chart") %>%
            rbind(anti_join_audio_charts_complete_scale %>%
              mutate(is_chart= "no_chart")) %>%
            # rbind(df_audio_features_complete_scale %>%
              # mutate(is_chart= "all")) %>%
            gather(key = variable, value = valor, 1:11) %>% 
            filter(variable== i ) %>%
              ggplot( aes(valor, fill = is_chart))+
                labs(title = paste("Densidad de", i),
                     subtitle = "Comparacion temas de chart vs no-chart")+
                geom_density(alpha = 0.2)) 
}

```


```{r}
for (i in features_continuas) {
  print(join_audio_charts_complete_scale %>%
            mutate(is_chart = "chart") %>%
            rbind(anti_join_audio_charts_complete_scale %>%
              mutate(is_chart= "no_chart")) %>%
            # rbind(df_audio_features_complete_scale %>%
              # mutate(is_chart= "all")) %>%
            gather(key = variable, value = valor, 1:11) %>% 
            filter(variable== i ) %>%
              ggplot( aes(valor, fill = is_chart))+
                labs(title = paste("Boxplot de", i),
                     subtitle = "Comparacion temas de chart vs no-chart")+
                geom_boxplot(alpha = 0.2)) 
}

```

Intento de hacer los histogramas de densidad con facete wrap PERO NO FUNCÓ !
```{r}
join_audio_charts_complete_scale %>%
  mutate(is_chart = "chart") %>%
  rbind(anti_join_audio_charts_complete_scale %>% 
          mutate(is_chart= "no_chart")) %>%
  gather(key = variable, value = valor, 1:11) %>% 
  # filter(!(variable %in% c("instrumentalness", "speechiness", "acousticness")) ) %>%
  filter(variable== "danceability" ) %>%
  ggplot( aes(valor, fill = is_chart))+ 
  geom_density(alpha = 0.2)+
  facet_wrap(~variable, ncol=1)

join_audio_charts_complete_scale %>%
  mutate(is_chart = "chart") %>%
  rbind(anti_join_audio_charts_complete_scale %>% 
          mutate(is_chart= "no_chart")) %>%
  gather(key = variable, value = valor, 1:11) %>% 
  filter(!(variable %in% c("instrumentalness", "speechiness", "acousticness", "cant_markets")) ) %>%
  # filter(variable %in% c("danceability", "tempo")) %>%
  # filter(variable== "tempo" ) %>%
  ggplot( aes(valor, fill = is_chart))+ 
  geom_density(alpha = 0.2)+
  facet_wrap(~variable, ncol=3)
  # facet_grid(variable~., space="free")
```


### Comparacion de medias
```{r}
media_no_chart = apply(anti_join_audio_charts_complete_scale,2, FUN = mean )
media_chart =apply(join_audio_charts_complete_scale,2, FUN = mean )

data.frame(media_chart, media_no_chart) %>% 
  mutate(dif = ((media_chart/ media_no_chart)-1)*100)

```


### Comparación de Coef de Var
```{r}
cv_no_chart = apply(anti_join_audio_charts_complete_scale,2, FUN =statip::cv )
cv_chart =apply(join_audio_charts_complete_scale,2, FUN = statip::cv )

data.frame(cv_chart, cv_no_chart) %>% 
  mutate(dif = ((cv_chart/ cv_no_chart)-1)*100)

```


## Qué temas perduran mucho en el ranking

### Artistas que mas aparecen en el chart
```{r}
join_audio_charts %>% 
  group_by(artist_name) %>% 
  summarise(n = n()) %>% 
  arrange(-n)
```

### Tracks que mas aparecen en el chart
```{r}
join_audio_charts %>% 
  group_by(track_name, artist_name,external_urls_spotify) %>% 
  summarise(n = n()) %>% 
  arrange(-n) %>% 
  select(track_name, n, everything(.))

```



## Variaciones de los features agrupados por artistas, album name, año lanzamiento 
```{r}
#Agregar por los artistas y clacular la varianza de los features entre sus temas
for (i in features_continuas){

  z <- aggregate(df_audio_features[, i], by= list(df_audio_features$artist_name), FUN= var)
  k<- mean(z[,2], na.rm = TRUE) #algo pasa que tira algunos NA. revisar! (y no hay NA en las filas)
  J <- median(z[,2], na.rm = TRUE) 

  hist(z[,2], main = paste("Histograma de varianza de", i, "(agrupados por artista)"))
  abline(v = k , col="red")
  abline(v = J , col="blue")

}


#Agregar a los album y clacular la varianza de los features entre sus temas

for (i in features_continuas){

  z <- aggregate(df_audio_features[, i], by= list(df_audio_features$album_name), FUN= var)
  k<- mean(z[,2], na.rm = TRUE)
  J <- median(z[,2], na.rm = TRUE) 

  hist(z[,2], main = paste("Histograma de varianza de", i, "(agrupados por album)"))
  abline(v = k , col="red")
  abline(v = J , col="blue")

}


for (i in features_continuas){

  z <- aggregate(df_audio_features[, i], by= list(df_audio_features$album_release_year), FUN= var)
  k<- mean(z[,2], na.rm = TRUE)
  J <- median(z[,2], na.rm = TRUE) 

  hist(z[,2], main = paste("Histograma de varianza de", i, "(agrupados por año de lanzamiento)"))
  abline(v = k , col="red")
  abline(v = J , col="blue")

}


boxplot(scale(df_audio_features[,features_continuas]), ylim=c(-5,5), las=3)


```


## evolucion de los streams

```{r}
library(vars)

df_charts %>% 
   mutate(week_start=as.Date(week_start)) %>% 
  group_by(week_start) %>% 
  summarise(reproductions = sum(Streams)) %>% 
  ggplot(aes(week_start, reproductions/10^6, color = "k", label = "Streams") )+
  geom_line()+
  geom_line(aes(x= week_start,y= rollmean(reproductions/10^6, 8, na.pad = T), color = "darkblue" , label = "Media movil" )  )+
  # geom_point()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        legend.position = "bottom")+
  labs(title = "Cantidad total de reproducciones por semana de canciones del chart",
       x = "Fecha", y ="Millones de reproducciones", fill = "Variable")+
  scale_y_continuous(labels = scales::comma)+
  scale_color_discrete(name = "Variable", labels = c("Media movil", "Streams"))


#agregar media movil
# cuanto duran los temas en el top 1 ??

```
```{r}
df_charts %>% 
   mutate(week_start=as.Date(week_start)) %>% 
  filter(Position == 1 ) %>% 
  group_by(week_start) %>% 
  summarise(reproductions = sum(Streams)) %>% 
  ggplot(aes(week_start, reproductions/10^6))+
  geom_line()+
  # geom_point()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  labs(title = "Cantidad total de reproducciones por semana de canciones del chart",
       x = "Fecha", y ="Millones de reproducciones")+
  scale_y_continuous(labels = scales::comma)
```
# ¿Cuánto tiempo tardan los temas en entrar en el chart?

```{r}
x <- df_charts %>% 
  mutate(week_start=as.Date(week_start),
         # week_end = as.Date(week_end),
         week_year = (year(week_start))) %>%
  group_by(Artist, Track_Name, URL) %>% 
  summarise( day_in = min(week_start),
             year_in = year(day_in)) %>% 
  ungroup() %>% 
  left_join(df_audio_features %>%
              dplyr::select("artist_key","track_name", "external_urls_spotify",
                    "album_release_date_precision", "album_release_date",,"album_release_year") %>%
              mutate(album_release_date = as.Date(album_release_date)),
            by = c(  "Track_Name"="track_name" ,
                   "Artist"= "artist_key", "URL"=  "external_urls_spotify" )) %>% 
  mutate( # tiempo_entrada_dias = day_in - album_release_date,
         tiempo_entrada_dias = case_when(day_in < album_release_date ~ 0,
                                         T ~ as.double(day_in - album_release_date)),
         tiempo_entrada_anio = year_in - year(album_release_date)) %>% 
  dplyr::select(Artist, Track_Name, album_release_date_precision,
                    album_release_date, day_in, tiempo_entrada_dias, year_in,tiempo_entrada_anio)
x %>% arrange(-tiempo_entrada_dias)

```


# ¿Cuánto tarda en alcanzar su pico? 

```{r}
x <- df_charts %>% 
  mutate(week_start=as.Date(week_start),
         week_year = (year(week_start))) %>%
  filter(Position == 1) %>% 
  group_by(Artist, Track_Name, URL) %>% 
  summarise( day_podio = min(week_start),
             year_podio = year(day_podio)) %>% 
  ungroup() %>% 
  left_join(df_charts %>% 
              mutate(week_start=as.Date(week_start) ), 
            by = c( "Track_Name" ,"Artist" , "URL" )  ) %>% 
  group_by(Artist, Track_Name, URL, day_podio, year_podio) %>%
  summarise( day_in = min(week_start),
             year_in = year(day_in) ) %>% 
  ungroup() %>% 
  mutate(  tiempo_podio_dias = day_podio - day_in,
         # tiempo_entrada_dias = case_when(day_in < album_release_date ~ 0,
         #                                 T ~ as.double(day_in - album_release_date)),
         tiempo_podio_anio = year_podio - year_in  )
x %>% arrange(-tiempo_podio_dias)  

```


# ¿Cuánto tiempo están en un chart? 




```{r}
# cantidad de semanas que estuvieron en el chart

df_charts %>% 
  mutate(week_start=as.Date(week_start),
         week_end = as.Date(week_end),
         week_year = (year(week_start))) %>%
  arrange(Artist, Track_Name) %>% 
  group_by(Artist, Track_Name, URL) %>% 
  summarise( day_in = min(week_start),
             year_in = year(day_in),
             day_max = max(week_end),
             year_max = year(day_max),
             duracion_chart_dias = day_max-day_in,
             duracion_chart_anio = year_max - year_in)


```


## Evolucion de los temas en el chart desde el momento 0

 Evolucion de las 5 canciones que hayan alcanzado el top 1 con mayores reproducciones
 Evolucion de las 5 canciones no hayan superado el top 190 con menores reproducciones
```{r}
# indicador de popularidad
popularidad <- df_charts %>% 
  group_by(Artist, Track_Name, URL) %>% 
  summarise(semanas_sum = n(),
            streams_sum = (sum(Streams, na.rm = T)/10^6 ),
            position_avg = mean(Position, na.rm = T)) %>% 
  ungroup() %>% 
  mutate(indicador = as.numeric(streams_sum*semanas_sum/position_avg) )


md.pattern(popularidad, rotate.names = TRUE)
popularidad[is.na(popularidad$indicador),]
```




```{r}
# panel de datos
panel <- df_charts %>%  
  # select(Artist, week_start, Position , Track_Name,  everything(.)) %>% 
  arrange(Artist, Track_Name, week_start, Position) %>% 
  group_by(Artist, Track_Name) %>% 
  mutate(contador = 1:n()) %>% 
  dplyr::select(Artist, week_start,contador, Position , Track_Name,  everything(.))
panel


#mas populares
filtro_top <- slice_max(.data = popularidad, n = 10, order_by = indicador)
panel %>% 
  mutate(week_start = as.Date(week_start)) %>% 
  filter(URL %in% filtro_top$URL) %>%
  ggplot(aes(week_start, -Position, color = URL)) +
  geom_point()+
  geom_line()+
  # geom_smooth()+
  theme(legend.position = "none") +
  labs(title = "Dinámica de las canciones más populares", subtitle = "Basado en indicador definido anteriormente",
       x = "Fecha", y = "Posición (en negativo)")

# cantidad reproducciones
filtro_top <- slice_max(.data = popularidad, n = 5, order_by = streams_sum)
panel %>% 
  mutate(week_start = as.Date(week_start)) %>% 
  filter(URL %in% filtro_top$URL) %>%
  ggplot(aes(week_start, -Position, color = URL)) +
  geom_point()+
  geom_line()+
  # geom_smooth()+
  theme(legend.position = "none") +
  labs(title = "Dinámica de las canciones con mayor reproducciones",
       x = "Fecha", y = "Posición (en negativo)")


#mayor cantidad de semanas
filtro_top <- slice_max(.data = popularidad, n = 7, order_by = semanas_sum)
panel %>% 
  mutate(week_start = as.Date(week_start)) %>% 
  filter(URL %in% filtro_top$URL) %>%
  ggplot(aes(week_start, -Position, color = URL)) +
  geom_point()+
  geom_line()+
  # geom_smooth()+
  theme(legend.position = "none") +
  labs(title = "Dinámica de las canciones con mayor prescencia en el chart",
       subtitle = "En cantidad de semanas",
       x = "Fecha", y = "Posición (en negativo)")


###########################################
 # MENORES
###########################################

#canciones menos populares
filtro_min <- slice_min(.data = popularidad, n = 150, order_by = c(indicador))
panel %>% 
  mutate(week_start = as.Date(week_start)) %>% 
  filter(URL %in% filtro_min$URL) %>%
  ggplot(aes(week_start, -Position, color = URL)) +
  geom_point()+
  geom_line()+
  # geom_smooth()+
  theme(legend.position = "none") +
  labs(title = "Dinámica de las canciones menos populares", subtitle = "Basado en indicador definido anteriormente",
       x = "Fecha", y = "Posición (en negativo)")


# menor cantidad reproducciones
filtro_min <- slice_min(.data = popularidad, n = 20, order_by = streams_sum)
panel %>% 
  mutate(week_start = as.Date(week_start)) %>% 
  filter(URL %in% filtro_min$URL) %>%
  ggplot(aes(week_start, -Position, color = URL)) +
  geom_point()+
  geom_line()+
  # geom_smooth()+
  theme(legend.position = "none") +
  labs(title = "Dinámica de las canciones con menores reproducciones",
       x = "Fecha", y = "Posición (en negativo)")

# menor cantidad reproducciones
filtro_min <- slice_min(.data = popularidad, n = 5, order_by = semanas_sum)
panel %>% 
  mutate(week_start = as.Date(week_start)) %>% 
  filter(URL %in% filtro_min$URL) %>%
  ggplot(aes(week_start, -Position, color = URL)) +
  geom_point()+
  geom_line()+
  # geom_smooth()+
  theme(legend.position = "none") +
  labs(title = "Dinámica de las canciones con menores reproducciones",
       x = "Fecha", y = "Posición (en negativo)")


```




## ¿Qué características tienen las bandas que solo una vez se pudieron meter en el ranking?
```{r}
# cantidad de bandas que se metieron una sola vez en el ranking
# unique((df_charts %>% 
unique((join_audio_charts %>% 
  group_by(artist_key) %>% 
  # group_by(Artist) %>% 
  summarise(n = n()) %>% 
  arrange(n) %>% 
  filter(n ==1))$artist_key)

```


