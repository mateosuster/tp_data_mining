---
title: "R Notebook"
output: html_notebook
---


```{r}
library(corrplot)
library(ggplot2)
library(tidyverse)
library(readxl)
library(mongolite)
library(sqldf)
library(isotree)
library(Rlof)
library(lubridate)
```
# Carga de bases
```{r}
#dir igal
 df_artist <- read.csv("C:/Users/igalk/OneDrive/Documentos/laburo/Data Mining FCEyN/Data mining/TP/data_mining/data/df_artist_sin_duplicados.csv")
# 

# # 
 df_charts <- read.csv("C:/Users/igalk/OneDrive/Documentos/laburo/Data Mining FCEyN/Data mining/TP/data_mining/data/df_charts_sin_duplicados.csv")
# # 
 df_audio_features <- read.csv("C:/Users/igalk/OneDrive/Documentos/laburo/Data Mining FCEyN/Data mining/TP/audio_features_plano_sin_duplicados.csv")

#dir Nacho
#df_artist <- read.csv()

#df_charts <- read.csv()

#df_audio_features <- read.csv()

#dir Mateo
#df_artist <- read.csv("data/df_artist_sin_duplicados.csv")
#df_charts <- read.csv("data/df_charts_sin_duplicados.csv")
#df_audio_features <- read.csv("data/audio_features_plano_sin_duplicados.csv")


#filtro NA
df_audio_features <-na.omit(df_audio_features) %>% 
  distinct()
df_charts <-na.omit(df_charts) %>% 
  distinct()


```


#Analisis de semanas y mercados
```{r}
#chequeo de semanas: tenemos 157 semanas en total, 200 temas por semana
df_charts %>% mutate(week_number = week(week_start), 
                     anio = year(week_start),
                     week_anio = paste(anio,week_number, sep = "-")) %>% 
  select(week_start, week_number, anio, week_anio) %>% 
  group_by(week_anio) %>% 
  summarise(n = n())
  

#armo columna con cantidad de paises donde está disponible cada canción

contar_market <- function(x){
q <- length(unlist(strsplit(x, split = ",")))
return (q)
  }
df_audio_features$cant_markets <- sapply(df_audio_features[,"markets_concat"], contar_market)

summary(df_audio_features$cant_markets) #hay canciones en cero países. Están dadas de baja

```

#vectores de features
```{r}
#features var continuos
features_continuas <- c('acousticness', 'danceability', 'duration_ms', 'energy', 'instrumentalness', 'liveness', 'loudness', 'speechiness',   'tempo', 'valence', 'cant_markets')

#features var_ categóricas
features_categoricas <- c('explicit', 'key_name', 'mode_name', "key_mode", "album_type", "markets_concat", "artist_concat")

```

#Join audio features y charts
```{r}

#Armamos un join para tener una tabla de charts con las caracteristicas de las canciones
# deberian quedar 22993 filas completas
join_audio_charts <- df_audio_features %>% 
  select("artist_name", "track_name", 
         "external_urls_spotify",
         features_continuas, features_categoricas) %>% 
  mutate(artist_track = paste(artist_name, track_name, sep = "-")) %>% 
  right_join( df_charts %>%
               select( "Track_Name", "Artist", 
                       "URL",
                       "Position", "Streams", "week_start", "week_end") %>% 
                mutate(artist_track = paste(Artist, Track_Name, sep = "-")),
               by  = c("external_urls_spotify" = "URL"))
               # by = "artist_track")
               # by = c("track_name" = "Track_Name", "artist_name" ="Artist"  ))

#Num de instancias con NA
sum(!complete.cases(join_audio_charts))
sum(complete.cases(join_audio_charts))

### ELIMINO NA
join_audio_charts <- na.omit(join_audio_charts)

# glimpse(join_audio_charts)
```

# histogramas y barplots de variables 
```{r}

##histograma de las variables continuas de audio_features

for (i in features_continuas){

  hist(df_audio_features[,i], main = paste("Histograma de", i, "(all data)"), xlab = i)
  abline(v = mean(df_audio_features[,i], na.rm = TRUE) , col="red")
  abline(v = median(df_audio_features[,i], na.rm = TRUE) , col="blue")
  legend("topright", legend = c("Media", "Mediana"), col=c("red", "blue"), lty =1)

}

#divido los features por su distribución
features_continuas_media <- c('danceability', 'tempo', 'valence', 'cant_markets')

features_continuas_mediana <- c('acousticness', 'duration_ms', 'energy', 'instrumentalness', 'liveness', 'loudness', 'speechiness', 'cant_markets')


##histograma de las variables continuas de charts
for (i in c(features_continuas, "Streams")){

  hist(join_audio_charts[,i], main = paste("Histograma de", i,  "(charts)"), xlab = i)
  abline(v = mean(join_audio_charts[,i], na.rm = TRUE) , col="red")
  abline(v = median(join_audio_charts[,i], na.rm = TRUE) , col="blue")

}

#divido features de charts según su distribución
audio_charts_continuas_media <- c('danceability', 'duration_ms', 'valence', 'cant_markets')

audio_charts_continuas_mediana <- c('acousticness', 'tempo', 'energy', 'instrumentalness', 'liveness', 'loudness', 'speechiness', 'cant_markets', "Streams")


##medidas resumen y barplots de las variables categoricas audio_features
for(i in features_categoricas){
  print(i)
  barplot(sort(table(df_audio_features[,i]),decreasing = T), las=2, 
          main = paste("Barplot de", i))
  # pie(table(df_features_categoricos[,i]))
}

#cantidad de veces que aparece cada país (lo sacamos porque na da nada interpretable)
#vector <- unlist(strsplit(df_audio_features[1,"markets_concat"], split = ","))
#x <- table (vector)
#x <- sort(x)
#barplot(x, las=2)



```

# Correlaciones
```{r}
#análisis de correlación numericas

#correlaciones en audio features
x <- cor(df_audio_features[,c(features_continuas_media, features_continuas_mediana)],  use =  "complete.obs")
corrplot(x, type = "upper", title = "Correlacion de atributos de audio", mar=c(0,0,1,0) )

#correlaciones en charts
x <- cor(join_audio_charts[,c(audio_charts_continuas_media, audio_charts_continuas_mediana)], use =  "complete.obs")
corrplot(x, type = "upper", title = "Correlacion de atributos de los Charts", mar=c(0,0,1,0) )

#chi2 test
tabla_key_album <- table(df_audio_features$key_name, df_audio_features$album_type)
cat("Tabla de contigencia entre key y album type\n")
tabla_key_album
chisq.test(tabla_key_album)

```


# Analisis de outliers

```{r}
#Outlier univariado

## Metricas de variacion

#coeficiente de variacion audio_features
cat("coeficiente de variacion\n")
cv <- round(apply(df_audio_features[,c(features_continuas_media, features_continuas_mediana)], 2, statip::cv, na_rm = T),2)
sort(cv, decreasing = T)

cat("\ndesvio_standard\n")
desvio_standard <- round(apply(df_audio_features[,c(features_continuas_media, features_continuas_mediana)], 2, sd),2)
desvio_standard[order(names(desvio_standard))]


#coeficiente de variacion charts
cat("coeficiente de variacion\n")
cv <- round(apply(join_audio_charts[,c(audio_charts_continuas_media, audio_charts_continuas_mediana)], 2, statip::cv, na_rm = T),2)
sort(cv, decreasing = T)

cat("\ndesvio_standard\n")
desvio_standard <- round(apply(join_audio_charts[,c(audio_charts_continuas_media, audio_charts_continuas_mediana)], 2, sd, na.rm=TRUE),2)
desvio_standard[order(names(desvio_standard))]

```
## Boxplots (filtrado de outliers de duration_ms y loudness)
```{r}
#método 1: boxplot. outlier = > 1.5 DIQ

#calculo bigotes para la variable duration
duration.bigote.superior <- boxplot(df_audio_features$duration_ms)$stats[5]
duration.bigote.inferior <- boxplot(df_audio_features$duration_ms)$stats[1]

#observo cuantos temas unicos superan el bigote
length(unique(df_audio_features["track_id"][(df_audio_features$duration_ms > duration.bigote.superior | 
                                               df_audio_features$duration_ms < duration.bigote.inferior),]))

#cuanto temas superan el bigote
length(df_audio_features["track_id"][(df_audio_features$duration_ms > duration.bigote.superior | 
                                               df_audio_features$duration_ms < duration.bigote.inferior),])
#cuantos artistas
length(unique(df_audio_features["artist_name"][df_audio_features$duration_ms < duration.bigote.inferior,]))

#observo nuevo boxplot con outliers filtados de duration_ms
boxplot(df_audio_features["duration_ms"][df_audio_features["duration_ms"] <= duration.bigote.superior ])

#calculo umbral para loudness
loudness.bigote.inferior <- boxplot(df_audio_features$loudness)$stats[1]

#guardo nuevo dataset filtrado (nro instancias 140k, perdemos 16k registros )
df_audio_features_filtrado <- df_audio_features %>% 
  filter(duration_ms <= duration.bigote.superior &
         loudness >= loudness.bigote.inferior)

```


## Normalizacion con z-score 
Para que sean comparables y los guardo en un nuevo DF

```{r}
#método 2: z-score para var que tienden a la normal
#filtro features numericos 
df_audio_features_zscore_media <- df_audio_features[,features_continuas_media]

#normalizo z score con las variables que tienden a la normal
for(i in 1:ncol(df_audio_features_zscore_media)){
  df_audio_features_zscore_media[, i] <- (df_audio_features_zscore_media[,i] -
                                   mean(df_audio_features_zscore_media[,i]))/(sd(df_audio_features_zscore_media[,i])) }

#normalizo z score modificado las variables que NO tienden a la normal


#analisis de z score
#variable: speechiness
umbral_zscore = 3
df_audio_features[df_audio_features_zscore_media$speechiness> umbral_zscore,] %>% 
  select(album_name,artist_name, speechiness ) %>% 
  arrange(-speechiness)
#falta z score con mediana





```


Hay 149,539 temas unicos que superan el bigote superior del boxplot de duration_ms (1.5 veces el RI)
```{r}

# Configuramos el tamaño del lienzo (ver "par" del paquete graphics)
par(mfrow=c(1, 1), mar=c(5, 12, 4, 2) ) 

# boxplot(df_audio_features_scale, horizontal = TRUE, las=1, xlab="z-score")
boxplot(df_audio_features_scale, horizontal = TRUE, las=1, xlab="z-score")
```

## LOF

```{r}
#outliers multivariados

#método 1: distancias de lof
df_audio_features_scale$lof_score <- lof(df_audio_features_scale, k=100)
top_lof <- head(df_audio_features_scale[order(df_audio_features_scale$lof_score,decreasing = TRUE),],4)

print(top_lof)

```
## Isolation Forest
```{r}
#método 2: isolation forest (categóticas y continuas)

#ajusto el modelo
iforest_sample = isolation.forest(df_audio_features_scale, sample_size = 10000, ntrees=100, ndim = 3, random_seed = 13)

#utilzo el metodo predict para calcula el score sobre todos los puntos
df_audio_features_scale$iforest_pred= predict(iforest_sample, df_audio_features_scale)

#que paises identifico?
top_ifores_sample <- head(df_audio_features[order(df_audio_features_scale$iforest_pred,
                                                  decreasing = T),], 10)
print(top_ifores_sample)
```

```{r}

#método 3: mahalanobis

#audio_features
df_audio_features_mahala <- df_audio_features
vector_medias = colMeans(df_audio_features_mahala[,features_continuas]) 
matriz_var_cov = cov(df_audio_features_mahala[,features_continuas])

# Creamos una variable con la distancia
df_audio_features_mahala$maha = sqrt(mahalanobis(df_audio_features_mahala[,features_continuas],vector_medias,matriz_var_cov))

# Los registros mas distantes. criterio del bastón partido
top_maha <- head(df_audio_features_mahala[order(df_audio_features_mahala$maha,decreasing = TRUE),],85)
plot(top_maha$maha) #se observa que las distancias se achican mucho a partir de las 85 más distantes al centro
unique(top_maha$artist_name)

table(top_maha$artist_name)

###############################

#charts
#audio_features
join_audio_charts_mahala <- join_audio_charts
vector_medias = colMeans(join_audio_charts_mahala[,features_continuas], na.rm = TRUE) 
matriz_var_cov = cov(join_audio_charts_mahala[,features_continuas], use = "complete.obs")

# Creamos una variable con la distancia
join_audio_charts_mahala$maha = sqrt(mahalanobis(join_audio_charts_mahala[,features_continuas],vector_medias,matriz_var_cov))

# Los registros mas distantes. criterio del bastón partido
top_maha <- head(join_audio_charts_mahala[order(join_audio_charts_mahala$maha,decreasing = TRUE),],200)
plot(top_maha$maha) #se observa que las distancias se achican mucho a partir de las 85 más distantes al centro
x <- as.data.frame(table(top_maha$artist_name))
x <- x[order(-x$Freq),]
print(x)

y <- as.data.frame(table(join_audio_charts$artist_name))

outlier <- function(z){
  
  print(z[1])
  #q <- y[y$Var1==z,"Freq"]
  
  #k <- x["Var1"==z, "Freq"]
  
  return ()
  }
x$prop_outlier <- sapply(x[,"Var1"], outlier)



```





# Preguntas de investigacion

## Patron Comun Canciones del Chart
¿Qué características tienen las canciones que están en el chart? ¿Cual es el patrón comun que tienen las canciones más escuchadas? (ver dispersiones, media, grafico comparativo)
```{r}
######################################################################
#                                                                    #
#      Análisis de los datos (respuesta a  las preguntas del TP)     #
#                                                                    #
######################################################################

#funcion para escalar variable
scale_vble <- function(x){
  (x - mean(x, na.rm = T))/sd(x, na.rm = T)
}

#borro NA y escalo los audio features del chart
join_audio_charts_complete <- na.omit(join_audio_charts)
join_audio_charts_complete_scale <- join_audio_charts_complete %>% 
  distinct() %>% 
  select(features_continuas)  %>% 
  mutate_all(scale_vble)
nrow(join_audio_charts_complete_scale)

#borro NA y escalo los audio features 
df_audio_features_complete <- na.omit(df_audio_features)
df_audio_features_complete_scale <- df_audio_features_complete %>%  
  distinct() %>% 
  select(features_continuas) %>% 
  mutate_all(scale_vble)
nrow(df_audio_features_complete)

#chequeo eliminacion de NA's
sum(!complete.cases(join_audio_charts_complete_scale))  
sum(!complete.cases(df_audio_features_complete))  
```
```{r}
#anti_join
anti_join_audio_charts <- df_audio_features %>% 
  select("artist_name", "track_name", "external_urls_spotify", features_continuas, features_categoricas) %>% 
  anti_join( df_charts %>%
               select( "Track_Name", "Artist", "URL"),
               by = c("external_urls_spotify" ="URL"))
               # by = c("track_name" = "Track_Name", "artist_name" ="Artist"  ))


anti_join_audio_charts_complete <- na.omit(anti_join_audio_charts)
anti_join_audio_charts_complete_scale <- anti_join_audio_charts_complete %>% 
  distinct() %>% 
  select(features_continuas)  %>% 
  mutate_all(scale_vble)
nrow(anti_join_audio_charts_complete_scale)
```
### Histogramas comparativos
(comentar o descomentar segun se trate de la comparacion de los features de los temas del chart vs todos o solo vs no charts)
```{r}
for (i in features_continuas) {
  print(join_audio_charts_complete_scale %>%
            mutate(is_chart = "chart") %>%
            rbind(anti_join_audio_charts_complete_scale %>%
              mutate(is_chart= "no_chart")) %>%
            # rbind(df_audio_features_complete_scale %>%
              # mutate(is_chart= "all")) %>%
            gather(key = variable, value = valor, 1:11) %>% 
            filter(variable== i ) %>%
              ggplot( aes(valor, fill = is_chart))+
                labs(title = paste("histograma de", i),
                     subtitle = "Comparacion temas de chart vs no-chart")+
                geom_density(alpha = 0.2)) 
}

```

Intento de hacer los histogramas de densidad con facete wrap PERO NO FUNCÓ !
```{r}
join_audio_charts_complete_scale %>%
  mutate(is_chart = "chart") %>%
  rbind(anti_join_audio_charts_complete_scale %>% 
          mutate(is_chart= "no_chart")) %>%
  gather(key = variable, value = valor, 1:11) %>% 
  # filter(!(variable %in% c("instrumentalness", "speechiness", "acousticness")) ) %>%
  filter(variable== "danceability" ) %>%
  ggplot( aes(valor, fill = is_chart))+ 
  geom_density(alpha = 0.2)+
  facet_wrap(~variable, ncol=1)

join_audio_charts_complete_scale %>%
  mutate(is_chart = "chart") %>%
  rbind(anti_join_audio_charts_complete_scale %>% 
          mutate(is_chart= "no_chart")) %>%
  gather(key = variable, value = valor, 1:11) %>% 
  filter(!(variable %in% c("instrumentalness", "speechiness", "acousticness", "cant_markets")) ) %>%
  # filter(variable %in% c("danceability", "tempo")) %>%
  # filter(variable== "tempo" ) %>%
  ggplot( aes(valor, fill = is_chart))+ 
  geom_density(alpha = 0.2)+
  facet_wrap(~variable, ncol=3)
  # facet_grid(variable~., space="free")
```


### Comparacion de medias
```{r}
media_no_chart = apply(anti_join_audio_charts_complete_scale,2, FUN = mean )
media_chart =apply(join_audio_charts_complete_scale,2, FUN = mean )

data.frame(media_chart, media_no_chart) %>% 
  mutate(dif = ((media_chart/ media_no_chart)-1)*100)

```


### Comparación de Coef de Var
```{r}
cv_no_chart = apply(anti_join_audio_charts_complete_scale,2, FUN =statip::cv )
cv_chart =apply(join_audio_charts_complete_scale,2, FUN = statip::cv )

data.frame(cv_chart, cv_no_chart) %>% 
  mutate(dif = ((cv_chart/ cv_no_chart)-1)*100)

```


## Qué temas perduran mucho en el ranking

### Artistas que mas aparecen en el chart
```{r}
join_audio_charts %>% 
  group_by(artist_name) %>% 
  summarise(n = n()) %>% 
  arrange(-n)
```

### Tracks que mas aparecen en el chart
```{r}
join_audio_charts %>% 
  group_by(track_name, artist_name,external_urls_spotify) %>% 
  summarise(n = n()) %>% 
  arrange(-n) %>% 
  select(track_name, n, everything(.))

```



## Variaciones de los features agrupados por artistas, album name, año lanzamiento 
```{r}
#Agregar por los artistas y clacular la varianza de los features entre sus temas
for (i in features_continuas){

  z <- aggregate(df_audio_features[, i], by= list(df_audio_features$artist_name), FUN= var)
  k<- mean(z[,2], na.rm = TRUE) #algo pasa que tira algunos NA. revisar! (y no hay NA en las filas)
  J <- median(z[,2], na.rm = TRUE) 

  hist(z[,2], main = paste("Histograma de varianza de", i, "(agrupados por artista)"))
  abline(v = k , col="red")
  abline(v = J , col="blue")

}


#Agregar a los album y clacular la varianza de los features entre sus temas

for (i in features_continuas){

  z <- aggregate(df_audio_features[, i], by= list(df_audio_features$album_name), FUN= var)
  k<- mean(z[,2], na.rm = TRUE)
  J <- median(z[,2], na.rm = TRUE) 

  hist(z[,2], main = paste("Histograma de varianza de", i, "(agrupados por album)"))
  abline(v = k , col="red")
  abline(v = J , col="blue")

}


for (i in features_continuas){

  z <- aggregate(df_audio_features[, i], by= list(df_audio_features$album_release_year), FUN= var)
  k<- mean(z[,2], na.rm = TRUE)
  J <- median(z[,2], na.rm = TRUE) 

  hist(z[,2], main = paste("Histograma de varianza de", i, "(agrupados por año de lanzamiento)"))
  abline(v = k , col="red")
  abline(v = J , col="blue")

}


boxplot(scale(df_audio_features[,features_continuas]), ylim=c(-5,5), las=3)


```

```

